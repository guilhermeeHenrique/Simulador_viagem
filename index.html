<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Gastos de Viagem</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --muted:#a7b0c0; --text:#e9eef7; --line:#232634;
      --ok:#7ee787; --bad:#ff7b72; --btn:#1f2a44; --btn2:#171a24;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0b0c10,#0f1220); color:var(--text);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    h1{ font-size:18px; margin:0 0 10px; }
    .grid{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media(min-width:920px){ .grid{ grid-template-columns:1.05fr .95fr; } }
    .card{
      background:rgba(18,20,26,.92); border:1px solid var(--line); border-radius:14px;
      padding:14px; box-shadow:var(--shadow);
    }
    .card h2{ font-size:14px; margin:0 0 10px; }
    .row{ display:grid; gap:10px; margin:10px 0; grid-template-columns:1fr; }
    @media(min-width:620px){
      .row.two{ grid-template-columns:1fr 1fr; }
      .row.three{ grid-template-columns:1fr 1fr 1fr; }
    }
    label{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input,select{
      width:100%; padding:10px; border-radius:10px;
      border:1px solid var(--line); background:#0e1018; color:var(--text); outline:none;
    }
    input[type="checkbox"]{ width:auto; }
    .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:10px 12px; border-radius:10px; border:1px solid var(--line);
      background:var(--btn2); color:var(--text); cursor:pointer; font-weight:800;
    }
    button.primary{ background:var(--btn); border-color:#2b3d66; }
    button.danger{ background:#2a1417; border-color:#4a1a21; }
    .kpi{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media(min-width:620px){ .kpi{ grid-template-columns:1fr 1fr; } }
    .box{ background:#0e1018; border:1px solid var(--line); border-radius:12px; padding:12px; }
    .small{ font-size:12px; color:var(--muted); }
    .big{ font-size:20px; font-weight:900; margin-top:6px; }
    .pill{
      display:inline-block; border:1px solid var(--line); border-radius:999px;
      padding:3px 8px; font-size:12px; color:var(--muted);
    }
    .warn{ color:var(--bad); }
    .ok{ color:var(--ok); }
    .table{ width:100%; border-collapse:collapse; margin-top:8px; }
    .table th,.table td{
      border-bottom:1px solid var(--line); padding:8px 6px; font-size:13px; text-align:left;
    }
    .table th{ color:var(--muted); font-weight:800; }
    details{
      border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#0e1018; margin-top:10px;
    }
    summary{ cursor:pointer; font-weight:900; }
    .info{
      display:inline-flex; align-items:center; justify-content:center;
      width:18px; height:18px; border-radius:50%;
      border:1px solid var(--line); background:#0e1018; color:var(--muted);
      font-weight:900; font-size:12px; cursor:help;
      padding:0; line-height:1;
    }
    .tip{
      position:fixed; z-index:9999; max-width:280px;
      background:#0e1018; border:1px solid var(--line); box-shadow:var(--shadow);
      border-radius:10px; padding:10px; color:var(--text); font-size:12px; line-height:1.35;
      display:none;
    }
    .tip .t{ color:var(--muted); font-weight:800; display:block; margin-bottom:4px; font-size:11px; letter-spacing:.2px; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Simulador de gastos de viagem</h1>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <h2>Configuração</h2>

        <div class="row two">
          <div>
            <label for="currency">
              Moeda
              <button class="info" type="button"
                data-title="Moeda"
                data-tip="Preencha tudo nesta moeda. O simulador não faz câmbio.">i</button>
            </label>
            <select id="currency">
              <option value="EUR">EUR €</option>
              <option value="USD">USD $</option>
              <option value="BRL">BRL R$</option>
              <option value="GBP">GBP £</option>
              <option value="CHF">CHF Fr</option>
            </select>
          </div>

          <div>
            <label for="people">
              Pessoas
              <button class="info" type="button"
                data-title="Pessoas"
                data-tip="Hospedagem (total) e Uber (grupo) são divididos automaticamente por pessoa nos resultados.">i</button>
            </label>
            <input id="people" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="departDT">
              Saída (data e hora)
              <button class="info" type="button"
                data-title="Saída"
                data-tip="Conta refeições do primeiro dia apenas depois desse horário.">i</button>
            </label>
            <input id="departDT" type="datetime-local" />
          </div>
          <div>
            <label for="returnDT">
              Volta (data e hora)
              <button class="info" type="button"
                data-title="Volta"
                data-tip="Conta refeições do último dia apenas antes desse horário.">i</button>
            </label>
            <input id="returnDT" type="datetime-local" />
          </div>
        </div>

        <h2 style="margin-top:14px;">Antes da viagem</h2>

        <div class="row two">
          <div>
            <label for="flightOut">
              Passagem (ida) por pessoa
              <button class="info" type="button"
                data-title="Passagem ida"
                data-tip="Valor por pessoa. O grupo = valor × pessoas.">i</button>
            </label>
            <input id="flightOut" type="number" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label for="flightBack">
              Passagem (volta) por pessoa
              <button class="info" type="button"
                data-title="Passagem volta"
                data-tip="Valor por pessoa. O grupo = valor × pessoas.">i</button>
            </label>
            <input id="flightBack" type="number" min="0" step="0.01" value="0" />
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="airportTransferGroupTotal">
              Aeroporto (ida+volta, total do grupo)
              <button class="info" type="button"
                data-title="Aeroporto"
                data-tip="Coloque o total do grupo somando ida e volta (público/Uber/misto, do jeito que você planeja).">i</button>
            </label>
            <input id="airportTransferGroupTotal" type="number" min="0" step="0.01" value="0" />
          </div>

          <div>
            <label for="lodgingGroupTotal">
              Hospedagem (total do grupo)
              <button class="info" type="button"
                data-title="Hospedagem"
                data-tip="Valor total da hospedagem inteira (não é por noite). Ex.: Airbnb total. O sistema divide por pessoa.">i</button>
            </label>
            <input id="lodgingGroupTotal" type="number" min="0" step="0.01" value="0" />
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="extrasPct">
              Extras %
              <button class="info" type="button"
                data-title="Extras"
                data-tip="Reserva automática aplicada no final (imprevistos, taxas, etc.).">i</button>
            </label>
            <input id="extrasPct" type="number" min="0" step="0.1" value="10" />
          </div>
          <div></div>
        </div>

        <h2 style="margin-top:14px;">Durante a viagem</h2>

        <div class="row three">
          <div>
            <label for="breakfast">
              Café (pessoa)
              <button class="info" type="button"
                data-title="Café"
                data-tip="Contado automaticamente por horário: janela 06:00.">i</button>
            </label>
            <input id="breakfast" type="number" min="0" step="0.01" value="5" />
          </div>
          <div>
            <label for="lunch">
              Almoço (pessoa)
              <button class="info" type="button"
                data-title="Almoço"
                data-tip="Contado automaticamente por horário: janela 11:00.">i</button>
            </label>
            <input id="lunch" type="number" min="0" step="0.01" value="12" />
          </div>
          <div>
            <label for="dinner">
              Jantar (pessoa)
              <button class="info" type="button"
                data-title="Jantar"
                data-tip="Contado automaticamente por horário: janela 18:00.">i</button>
            </label>
            <input id="dinner" type="number" min="0" step="0.01" value="15" />
          </div>
        </div>

        <div class="row three">
          <div>
            <label for="snacksPerDay">
              Lanches (pessoa/dia)
              <button class="info" type="button"
                data-title="Lanches"
                data-tip="Aplicado por dia de presença no destino.">i</button>
            </label>
            <input id="snacksPerDay" type="number" min="0" step="0.01" value="6" />
          </div>

          <div>
            <label for="toursPerDay">
              Passeios (pessoa/dia)
              <button class="info" type="button"
                data-title="Passeios"
                data-tip="Estimativa média por dia de presença (ingressos, tours etc.).">i</button>
            </label>
            <input id="toursPerDay" type="number" min="0" step="0.01" value="0" />
          </div>

          <div>
            <label for="drinksFixedTotal">
              Bebidas (fixo da viagem)
              <button class="info" type="button"
                data-title="Bebidas"
                data-tip="Valor fixo para a viagem inteira. Marque se for por pessoa.">i</button>
            </label>
            <input id="drinksFixedTotal" type="number" min="0" step="0.01" value="0" />
            <div class="inline" style="margin-top:6px;">
              <input id="drinksIsPerPerson" type="checkbox" />
              <label for="drinksIsPerPerson" style="margin:0;color:var(--muted);font-size:12px;">
                é por pessoa
              </label>
            </div>
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="souvenirsFixedTotal">
              Souvenirs (fixo da viagem)
              <button class="info" type="button"
                data-title="Souvenirs"
                data-tip="Compras/lembranças. Valor fixo da viagem inteira. Marque se for por pessoa.">i</button>
            </label>
            <input id="souvenirsFixedTotal" type="number" min="0" step="0.01" value="0" />
            <div class="inline" style="margin-top:6px;">
              <input id="souvenirsIsPerPerson" type="checkbox" />
              <label for="souvenirsIsPerPerson" style="margin:0;color:var(--muted);font-size:12px;">
                é por pessoa
              </label>
            </div>
          </div>

          <div>
            <label for="publicPassPerDay">
              Passe 24h (pessoa/dia)
              <button class="info" type="button"
                data-title="Passe 24h"
                data-tip="Transporte público por pessoa por dia. O sistema calcula para todos os dias de presença.">i</button>
            </label>
            <input id="publicPassPerDay" type="number" min="0" step="0.01" value="0" />
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="uberRideGroup">
              Uber (valor por viagem, grupo)
              <button class="info" type="button"
                data-title="Uber por viagem"
                data-tip="Valor de 1 corrida do Uber para o grupo. O simulador usa média fixa de 4 corridas por dia.">i</button>
            </label>
            <input id="uberRideGroup" type="number" min="0" step="0.01" value="0" />
          </div>

          <div>
            <label>
              Corridas/dia
              <button class="info" type="button"
                data-title="Corridas/dia"
                data-tip="Regra fixa: 4 corridas por dia (não editável).">i</button>
            </label>
            <div class="pill"><span class="mono">4</span> corridas por dia</div>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnCalc">Recalcular</button>
          <button id="btnSave">Salvar</button>
          <button id="btnLoad">Carregar</button>
          <button class="danger" id="btnReset">Resetar</button>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="card">
        <h2>Resultado</h2>

        <div class="kpi">
          <div class="box">
            <div class="small">Total por pessoa</div>
            <div class="big" id="totalPerPersonMain">—</div>
            <div class="small" id="tripMeta">—</div>
          </div>
          <div class="box">
            <div class="small">Total do grupo</div>
            <div class="big" id="totalGroupMain">—</div>
            <div class="small" id="countsPill">—</div>
          </div>
        </div>

        <h2 style="margin-top:14px;">Comparação de transporte no destino</h2>
        <table class="table" aria-label="Transporte">
          <thead>
            <tr>
              <th>Cenário</th>
              <th>Por pessoa</th>
              <th>Grupo</th>
            </tr>
          </thead>
          <tbody id="transportCompare"></tbody>
        </table>

        <details>
          <summary>Resumo por categoria</summary>
          <table class="table" aria-label="Categorias">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Por pessoa</th>
                <th>Grupo</th>
              </tr>
            </thead>
            <tbody id="breakdownBody"></tbody>
          </table>
          <div class="small" id="extrasLine" style="margin-top:8px;">—</div>
        </details>

        <details>
          <summary>Detalhes dos cálculos</summary>
          <div class="small" id="detailsText" style="margin-top:8px;">—</div>
        </details>
      </div>
    </div>
  </div>

  <div class="tip" id="tip" role="tooltip" aria-hidden="true"></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const currencySymbols = { EUR:"€", USD:"$", BRL:"R$", GBP:"£", CHF:"Fr" };

    function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
    function nn(v){ return Math.max(0, n(v)); }
    function fmtMoney(amount, cur){
      const sym = currencySymbols[cur] ?? "";
      return `${sym} ${amount.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`;
    }

    // Date helpers
    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
    function sameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function addDays(d, days){ const x=new Date(d); x.setDate(x.getDate()+days); return x; }

    function presenceDays(departDT, returnDT){
      const a = startOfDay(departDT).getTime();
      const b = startOfDay(returnDT).getTime();
      if (b < a) return 0;
      return Math.round((b-a)/(24*3600*1000)) + 1;
    }

    // Meal windows
    const MEAL_WINDOWS = { breakfast:6, lunch:11, dinner:18 };
    function mealCountForTrip(departDT, returnDT){
      const counts = { breakfast:0, lunch:0, dinner:0 };
      if (returnDT < departDT) return counts;

      const dayCount = presenceDays(departDT, returnDT);
      for (let i=0;i<dayCount;i++){
        const day = addDays(startOfDay(departDT), i);
        const isStart = sameDay(day, departDT);
        const isEnd = sameDay(day, returnDT);

        for (const meal of ["breakfast","lunch","dinner"]){
          const h = MEAL_WINDOWS[meal];
          const mealTime = new Date(day.getFullYear(), day.getMonth(), day.getDate(), h, 0, 0, 0);

          let include=false;
          if (isStart && isEnd) include = (mealTime >= departDT) && (mealTime <= returnDT);
          else if (isStart) include = (mealTime >= departDT);
          else if (isEnd) include = (mealTime <= returnDT);
          else include = true;

          if (include) counts[meal] += 1;
        }
      }
      return counts;
    }

    function getInputs(){
      const cur = $("currency").value;
      const people = Math.max(1, Math.floor(n($("people").value)));

      const departRaw = $("departDT").value;
      const returnRaw = $("returnDT").value;
      const departDT = departRaw ? new Date(departRaw) : null;
      const returnDT = returnRaw ? new Date(returnRaw) : null;

      return {
        cur, people, departDT, returnDT,

        flightOut: nn($("flightOut").value),
        flightBack: nn($("flightBack").value),
        airportTransferGroupTotal: nn($("airportTransferGroupTotal").value),
        lodgingGroupTotal: nn($("lodgingGroupTotal").value),
        extrasPct: nn($("extrasPct").value),

        breakfast: nn($("breakfast").value),
        lunch: nn($("lunch").value),
        dinner: nn($("dinner").value),
        snacksPerDay: nn($("snacksPerDay").value),
        toursPerDay: nn($("toursPerDay").value),

        drinksFixedTotal: nn($("drinksFixedTotal").value),
        drinksIsPerPerson: $("drinksIsPerPerson").checked,

        souvenirsFixedTotal: nn($("souvenirsFixedTotal").value),
        souvenirsIsPerPerson: $("souvenirsIsPerPerson").checked,

        publicPassPerDay: nn($("publicPassPerDay").value),
        uberRideGroup: nn($("uberRideGroup").value),
      };
    }

    function renderError(msg){
      $("totalPerPersonMain").textContent = "—";
      $("totalGroupMain").textContent = "—";
      $("tripMeta").innerHTML = `<span class="warn">${msg}</span>`;
      $("countsPill").textContent = "—";
      $("transportCompare").innerHTML = "";
      $("breakdownBody").innerHTML = "";
      $("extrasLine").textContent = "—";
      $("detailsText").textContent = "—";
    }

    function rowHtml(cat, perPerson, group, cur){
      return `<tr>
        <td>${cat}</td>
        <td>${fmtMoney(perPerson, cur)}</td>
        <td>${fmtMoney(group, cur)}</td>
      </tr>`;
    }

    function compute(){
      const x = getInputs();

      if (!x.departDT || !x.returnDT) return renderError("Preencha saída e volta.");
      if (x.returnDT < x.departDT) return renderError("A volta não pode ser antes da saída.");

      const days = presenceDays(x.departDT, x.returnDT);
      const meals = mealCountForTrip(x.departDT, x.returnDT);
      const ridesPerDay = 4;

      // --- Common costs (do not depend on transport scenario) ---
      const flightsPerPerson = x.flightOut + x.flightBack;
      const flightsGroup = flightsPerPerson * x.people;

      const airportGroup = x.airportTransferGroupTotal;
      const airportPerPerson = airportGroup / x.people;

      const lodgingGroup = x.lodgingGroupTotal;         // TOTAL (not per night)
      const lodgingPerPerson = lodgingGroup / x.people;

      // Food block
      const mealsPerPerson =
        meals.breakfast * x.breakfast +
        meals.lunch * x.lunch +
        meals.dinner * x.dinner;

      const snacksPerPerson = x.snacksPerDay * days;
      const toursPerPerson = x.toursPerDay * days;

      const drinksGroup = x.drinksIsPerPerson ? (x.drinksFixedTotal * x.people) : x.drinksFixedTotal;
      const drinksPerPerson = drinksGroup / x.people;

      const souvenirsGroup = x.souvenirsIsPerPerson ? (x.souvenirsFixedTotal * x.people) : x.souvenirsFixedTotal;
      const souvenirsPerPerson = souvenirsGroup / x.people;

      const foodPerPerson = mealsPerPerson + snacksPerPerson + toursPerPerson + drinksPerPerson;
      const foodGroup = foodPerPerson * x.people;

      const commonGroup =
        flightsGroup +
        airportGroup +
        lodgingGroup +
        foodGroup +
        souvenirsGroup;

      // --- Transport scenarios (destination) ---
      const transportPublicGroup = x.publicPassPerDay * days * x.people; // per person per day
      const transportUberGroup = x.uberRideGroup * ridesPerDay * days;   // per ride for group × 4 rides/day × days

      // Mixed fixed proportion: ALWAYS 1 day Uber + the rest Pass (as you requested)
      const mixedUberDays = Math.min(1, days);
      const mixedPassDays = Math.max(0, days - mixedUberDays);
      const transportMixedGroup =
        (x.uberRideGroup * ridesPerDay * mixedUberDays) +
        (x.publicPassPerDay * mixedPassDays * x.people);

      const scenarios = [
        { key:"public", name:"Só ônibus/passe", transportGroup: transportPublicGroup },
        { key:"uber",   name:"Só Uber",         transportGroup: transportUberGroup },
        { key:"mixed",  name:`Misto (1 dia Uber + ${mixedPassDays} dia(s) passe)`, transportGroup: transportMixedGroup },
      ];

      // Choose "misto" as main displayed total (most realistic default)
      const main = scenarios.find(s => s.key === "mixed");

      function totalsForScenario(transportGroup){
        const baseGroup = commonGroup + transportGroup;
        const extras = baseGroup * (x.extrasPct / 100);
        const totalGroup = baseGroup + extras;
        const totalPerPerson = totalGroup / x.people;
        return { baseGroup, extras, totalGroup, totalPerPerson };
      }

      const mainTotals = totalsForScenario(main.transportGroup);

      // KPIs
      $("totalPerPersonMain").textContent = fmtMoney(mainTotals.totalPerPerson, x.cur);
      $("totalGroupMain").textContent = fmtMoney(mainTotals.totalGroup, x.cur);

      const depStr = x.departDT.toLocaleString("pt-BR");
      const retStr = x.returnDT.toLocaleString("pt-BR");
      $("tripMeta").innerHTML = `<span class="ok">${x.people} pessoa(s)</span> • ${depStr} → ${retStr}`;
      $("countsPill").textContent = `dias ${days} • café ${meals.breakfast} • almoço ${meals.lunch} • jantar ${meals.dinner} • Uber ${ridesPerDay} corridas/dia`;

      // Transport comparison table (exact values)
      const tRows = scenarios.map(s=>{
        const per = s.transportGroup / x.people;
        return rowHtml(s.name, per, s.transportGroup, x.cur);
      }).join("");
      $("transportCompare").innerHTML = tRows;

      // Breakdown by category (using MAIN scenario transport)
      const transportPerPersonMain = main.transportGroup / x.people;

      const breakdown = [];
      breakdown.push(rowHtml("Passagens", flightsPerPerson, flightsGroup, x.cur));
      breakdown.push(rowHtml("Aeroporto", airportPerPerson, airportGroup, x.cur));
      breakdown.push(rowHtml("Hospedagem", lodgingPerPerson, lodgingGroup, x.cur));
      breakdown.push(rowHtml("Alimentação + passeios + bebidas", foodPerPerson, foodGroup, x.cur));
      breakdown.push(rowHtml("Souvenirs", souvenirsPerPerson, souvenirsGroup, x.cur));
      breakdown.push(rowHtml("Transporte no destino (misto)", transportPerPersonMain, main.transportGroup, x.cur));
      breakdown.push(rowHtml(`Extras (${x.extrasPct.toFixed(1)}%)`, mainTotals.extras / x.people, mainTotals.extras, x.cur));
      $("breakdownBody").innerHTML = breakdown.join("");

      $("extrasLine").textContent =
        `Base (misto): ${fmtMoney(mainTotals.baseGroup, x.cur)} grupo • Total (misto): ${fmtMoney(mainTotals.totalGroup, x.cur)} grupo`;

      // Details (include full trip totals for each transport scenario)
      const details = [];
      details.push(`<div><b>Refeições</b> (janelas) café 06:00 • almoço 11:00 • jantar 18:00</div>`);
      details.push(`<div>Saída: <span class="mono">${x.departDT.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</span> • Volta: <span class="mono">${x.returnDT.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</span></div>`);
      details.push(`<div style="margin-top:8px;"><b>Transporte no destino</b></div>`);
      details.push(`<div>Ônibus/passe: passe(pessoa/dia) × dias × pessoas</div>`);
      details.push(`<div>Uber: valor(viagem do grupo) × <b>4</b> viagens/dia × dias</div>`);
      details.push(`<div>Misto: <b>1</b> dia Uber + resto passe</div>`);

      details.push(`<div style="margin-top:10px;"><b>Totais da viagem (com extras) por cenário</b></div>`);
      for (const s of scenarios){
        const tt = totalsForScenario(s.transportGroup);
        details.push(`<div>${s.name}: ${fmtMoney(tt.totalPerPerson, x.cur)} por pessoa • ${fmtMoney(tt.totalGroup, x.cur)} grupo</div>`);
      }

      details.push(`<div style="margin-top:10px;"><b>Common (sem transporte)</b>: ${fmtMoney(commonGroup, x.cur)} grupo</div>`);
      $("detailsText").innerHTML = details.join("");
    }

    // Save / Load / Reset
    const STORAGE_KEY = "trip_simulator_clean_v4";

    function saveState(){
      const els = document.querySelectorAll("input, select");
      const obj = {};
      els.forEach(el=>{
        if(!el.id) return;
        obj[el.id] = (el.type === "checkbox") ? el.checked : el.value;
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      compute();
      alert("Salvo.");
    }

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return alert("Nada salvo.");
      const obj = JSON.parse(raw);
      Object.entries(obj).forEach(([id,val])=>{
        const el = $(id);
        if(!el) return;
        if(el.type === "checkbox") el.checked = Boolean(val);
        else el.value = val;
      });
      compute();
      alert("Carregado.");
    }

    function resetAll(){
      localStorage.removeItem(STORAGE_KEY);

      $("currency").value="EUR";
      $("people").value="1";
      $("departDT").value="";
      $("returnDT").value="";

      $("flightOut").value="0";
      $("flightBack").value="0";
      $("airportTransferGroupTotal").value="0";
      $("lodgingGroupTotal").value="0";
      $("extrasPct").value="10";

      $("breakfast").value="5";
      $("lunch").value="12";
      $("dinner").value="15";
      $("snacksPerDay").value="6";
      $("toursPerDay").value="0";

      $("drinksFixedTotal").value="0";
      $("drinksIsPerPerson").checked=false;

      $("souvenirsFixedTotal").value="0";
      $("souvenirsIsPerPerson").checked=false;

      $("publicPassPerDay").value="0";
      $("uberRideGroup").value="0";

      compute();
      alert("Resetado.");
    }

    // Tooltip
    const tip = $("tip");
    let tipHideTimer = null;

    function showTip(btn){
      const title = btn.getAttribute("data-title") || "Info";
      const text = btn.getAttribute("data-tip") || "";
      tip.innerHTML = `<span class="t">${title}</span>${text}`;
      tip.style.display = "block";
      tip.setAttribute("aria-hidden","false");

      const r = btn.getBoundingClientRect();
      const pad = 10;
      const maxX = window.innerWidth - tip.offsetWidth - pad;
      const maxY = window.innerHeight - tip.offsetHeight - pad;

      let x = r.left + window.scrollX + 22;
      let y = r.top + window.scrollY + 22;

      x = Math.max(pad, Math.min(x, maxX));
      y = Math.max(pad, Math.min(y, maxY));

      tip.style.left = x + "px";
      tip.style.top = y + "px";
    }
    function hideTip(){
      tip.style.display = "none";
      tip.setAttribute("aria-hidden","true");
    }

    function wire(){
      $("btnCalc").addEventListener("click", compute);
      $("btnSave").addEventListener("click", saveState);
      $("btnLoad").addEventListener("click", loadState);
      $("btnReset").addEventListener("click", resetAll);

      document.querySelectorAll("input, select").forEach(el=>{
        el.addEventListener("input", compute);
        el.addEventListener("change", compute);
      });

      document.querySelectorAll(".info").forEach(btn=>{
        btn.addEventListener("mouseenter", ()=>{
          clearTimeout(tipHideTimer);
          showTip(btn);
        });
        btn.addEventListener("mouseleave", ()=>{
          tipHideTimer = setTimeout(hideTip, 120);
        });
        btn.addEventListener("focus", ()=>{
          clearTimeout(tipHideTimer);
          showTip(btn);
        });
        btn.addEventListener("blur", hideTip);
        btn.addEventListener("click", ()=>{
          if (tip.style.display === "block") hideTip();
          else showTip(btn);
        });
      });

      window.addEventListener("scroll", hideTip, { passive:true });
      window.addEventListener("resize", hideTip);

      compute();
    }

    wire();
  </script>
</body>
</html>
